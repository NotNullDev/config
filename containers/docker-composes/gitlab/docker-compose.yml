services:
  gitlab:
    container_name: gitlab
    image: "gitlab/gitlab-ce:latest"
    restart: always
    hostname: "gitlab.internal.com"
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab.internal.com'
        gitlab_rails['gitlab_shell_ssh_port'] = 222
        letsencrypt['enable'] = false
        nginx['redirect_http_to_https'] = false
        registry_nginx['redirect_http_to_https'] = false
        mattermost_nginx['redirect_http_to_https'] = false
        gitlab_rails['usage_ping_enabled'] = false
    ports:
      - "80:80"
      - "443:443"
      - "222:22"
    volumes:
      - "gitlab-config:/etc/gitlab"
      - "gitlab-logs:/var/log/gitlab"
      - "gitlab-data:/var/opt/gitlab"
    shm_size: '256m'
    networks:
      - gitlab

  gitlab-runner:
    container_name: gitlab-runner
    image: gitlab/gitlab-runner
    restart: always
    volumes:
      - "gitlab-runner-config:/etc/gitlab-runner"
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      mode: replicated
      replicas: 1
    networks:
      - gitlab
  registry:
    image: registry:2
    container_name: container-registry
    ports:
      - "5000:5000"
    restart: always
    volumes:
      - "registry-data:/var/lib/registry:rw"
    networks:
      - gitlab


networks:
  gitlab:
    name: gitlab

volumes:
  gitlab-config:
    name: gitlab-config
  gitlab-logs:
    name: gitlab-logs
  gitlab-data:
    name: gitlab-data
  gitlab-runner-config:
    name: gitlab-runner-config
  registry-data:
    name: registry-data